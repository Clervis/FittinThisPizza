{% extends "base.html" %}

{% block content %}
  {% for css_file in bokeh_css %}
    <link rel="stylesheet" href="{{ css_file }}" />
  {% endfor %}

  {% for js_file in bokeh_js %}
    <script src="{{ js_file }}"></script>
  {% endfor %}

  <section class="chart-card {{ '' if is_mobile else 'card' }}" style="margin-top: 0.3rem;">
    <div class="chart-scroll {{ 'chart-fullbleed' if is_mobile else '' }}">
      {% if div is iterable and div is not string %}
        {% for item in div %}
          {{ item | safe }}
        {% endfor %}
      {% else %}
        {{ div | safe }}
      {% endif %}
    </div>
  </section>

  {{ script | safe }}

  {% if range_controls %}
    <section class="card range-card" style="margin-top: 0.8rem;">
      <div
        class="range-controls"
        data-range-controls
        data-plot-name="{{ range_controls.plot_name }}"
        data-christian-source="{{ range_controls.christian_source }}"
        data-krysty-source="{{ range_controls.krysty_source }}"
        data-max-start="{{ range_controls.max_start_ms }}"
        data-max-end="{{ range_controls.max_end_ms }}"
        data-days-ms="{{ range_controls.days_ms }}"
      >
        <button class="button range-button" type="button" data-range="max">Max</button>
        <button class="button range-button" type="button" data-range="30">1 Month</button>
        <button class="button range-button" type="button" data-range="14">2 Weeks</button>
        <button class="button range-button" type="button" data-range="7">1 Week</button>
      </div>
    </section>
  {% endif %}

  <section class="data-grid" style="margin-top: 2rem;">
    <div class="card" style="overflow-x: auto;">
      <h3>Fitness Data</h3>
      <table class="editable-table">
        <thead>
          <tr>
            <th>Date</th>
            <th class="weight-col">Christian<br />Weight</th>
            <th>Christian<br />Target</th>
            <th class="weight-col">Krysty<br />Weight</th>
            <th>Krysty<br />Target</th>
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
            <tr>
              {% set c_weight = row["Christian Weight"] %}
              {% set k_weight = row["Krysty Weight"] %}
              {% set c_target = row["Christian Target"] %}
              {% set k_target = row["Krysty Target"] %}
              {% set has_weight = c_weight or k_weight %}
              <form method="post" id="edit-{{ loop.index }}">
                <input type="hidden" name="action" value="edit_row" />
                <input type="hidden" name="date" value="{{ row['DateISO'] }}" />
              </form>
              <td data-has-weight="{{ 'true' if has_weight else 'false' }}">
                {{ row["DateISO"].split("-")[1] | int }}/{{ row["DateISO"].split("-")[2] | int }}
              </td>
              <td class="weight-col">
                <input class="weight-input" type="number" step="0.1" name="christian_weight" value="{{ "%.1f"|format(c_weight|float) if c_weight else "" }}" form="edit-{{ loop.index }}" />
              </td>
              <td>{{ "%.1f"|format(c_target|float) if c_target else "" }}</td>
              <td class="weight-col">
                <input class="weight-input" type="number" step="0.1" name="krysty_weight" value="{{ "%.1f"|format(k_weight|float) if k_weight else "" }}" form="edit-{{ loop.index }}" />
              </td>
              <td>{{ "%.1f"|format(k_target|float) if k_target else "" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="pagination" id="tablePagination"></div>
    </div>
  </section>

  <script>
    const rowsPerPage = 7;
    const table = document.querySelector(".editable-table");
    const tableRows = Array.from(table?.querySelectorAll("tbody tr") ?? []);
    const pagination = document.getElementById("tablePagination");
    const weightInputs = Array.from(table?.querySelectorAll(".weight-input") ?? []);

    const getDefaultPage = () => {
      const weightIndex = tableRows.findIndex((row) =>
        row.querySelector("td")?.dataset.hasWeight === "true"
      );
      const index = weightIndex >= 0 ? weightIndex : 0;
      return Math.floor(index / rowsPerPage) + 1;
    };

    const renderPage = (page) => {
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      tableRows.forEach((row, idx) => {
        row.style.display = idx >= start && idx < end ? "" : "none";
      });
      renderPagination(page);
    };

    const renderPagination = (activePage) => {
      if (!pagination) return;
      const totalPages = Math.ceil(tableRows.length / rowsPerPage) || 1;
      pagination.innerHTML = "";

      const addButton = (label, targetPage, isDisabled = false, isActive = false) => {
        const button = document.createElement("button");
        button.type = "button";
        button.textContent = label;
        button.className = isActive ? "page-button active" : "page-button";
        button.disabled = isDisabled;
        if (!isDisabled && targetPage) {
          button.addEventListener("click", () => renderPage(targetPage));
        }
        pagination.appendChild(button);
      };

      addButton("⏮", 1, activePage === 1);
      addButton("◀", activePage - 1, activePage === 1);

      const startPage = Math.max(1, activePage - 2);
      const endPage = Math.min(totalPages, activePage + 2);

      for (let page = startPage; page <= endPage; page += 1) {
        addButton(`${page}`, page, false, page === activePage);
      }

      addButton("▶", activePage + 1, activePage === totalPages);
      addButton("⏭", totalPages, activePage === totalPages);
    };

    if (tableRows.length > rowsPerPage) {
      renderPage(getDefaultPage());
    }

    weightInputs.forEach((input) => {
      input.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          const formId = input.getAttribute("form");
          const form = formId ? document.getElementById(formId) : input.closest("form");
          if (form) {
            event.preventDefault();
            form.requestSubmit();
          }
        }
      });
    });

    const setupRangeControls = () => {
      const container = document.querySelector("[data-range-controls]");
      if (!container || !window.Bokeh || !Bokeh.documents || !Bokeh.documents.length) return;

      const doc = Bokeh.documents[0];
      const plotName = container.dataset.plotName;
      const cName = container.dataset.christianSource;
      const kName = container.dataset.krystySource;
      const plot = doc.get_model_by_name(plotName);
      const christianSource = doc.get_model_by_name(cName);
      const krystySource = doc.get_model_by_name(kName);
      if (!plot || !christianSource || !krystySource) return;

      const maxStart = Number(container.dataset.maxStart);
      const maxEnd = Number(container.dataset.maxEnd);
      const daysMs = Number(container.dataset.daysMs);
      const xRange = plot.x_range;
      const yRange = plot.y_range;
      const krystyRange = plot.extra_y_ranges.krysty;

      const updateAxisRanges = (startMs, endMs) => {
        const cData = christianSource.data;
        const kData = krystySource.data;
        const cX = cData.x || [];
        const cY = cData.y || [];
        const cTarget = cData.target || [];
        const kY = kData.y || [];
        const kTarget = kData.target || [];

        const cWindow = [];
        const kWindow = [];

        for (let i = 0; i < cX.length; i += 1) {
          const xVal = cX[i];
          if (xVal == null || xVal < startMs || xVal > endMs) {
            continue;
          }

          const cTargetVal = cTarget[i];
          const cWeightVal = cY[i];
          if (cTargetVal != null) cWindow.push(cTargetVal);
          if (cWeightVal != null) cWindow.push(cWeightVal);

          const kTargetVal = kTarget[i];
          const kWeightVal = kY[i];
          if (kTargetVal != null) kWindow.push(kTargetVal);
          if (kWeightVal != null) kWindow.push(kWeightVal);
        }

        const cValues = cWindow.length ? cWindow : [0, 1];
        const cMin = Math.min(...cValues);
        const cMax = Math.max(...cValues);
        const cSpan = cMax - cMin || 1;
        yRange.start = cMin - cSpan * 0.6;
        yRange.end = cMax;

        const kValues = kWindow.length ? kWindow : [0, 1];
        const kMin = Math.min(...kValues);
        const kMax = Math.max(...kValues);
        const kSpan = kMax - kMin || 1;
        krystyRange.start = kMin;
        krystyRange.end = kMax + kSpan * 0.6;
      };

      const applyWindow = (days) => {
        if (days === "max") {
          xRange.start = maxStart;
          xRange.end = maxEnd;
          updateAxisRanges(maxStart, maxEnd);
        } else {
          const daysNum = Number(days);
          const start = Math.max(maxStart, maxEnd - daysNum * daysMs);
          xRange.start = start;
          xRange.end = maxEnd;
          updateAxisRanges(start, maxEnd);
        }
        xRange.change.emit();
        yRange.change.emit();
        krystyRange.change.emit();
      };

      container.querySelectorAll("button[data-range]").forEach((button) => {
        button.addEventListener("click", () => applyWindow(button.dataset.range));
      });
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", setupRangeControls);
    } else {
      setupRangeControls();
    }

  </script>
{% endblock %}
