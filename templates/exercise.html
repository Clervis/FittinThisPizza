{% extends "base.html" %}

{% block content %}
  <section class="card" style="margin-top: 0.3rem;">
    <div class="exercise-header">
      <h3>Exercise</h3>
      <div class="exercise-legend">
        <span class="legend-bubble legend-bubble--christian">Christian</span>
        <span class="legend-bubble legend-bubble--krysty">Kryst</span>
      </div>
    </div>
    <div class="exercise-nav">
      <a class="nav-arrow" href="{{ url_for('exercise', start=prev_start) }}">&#8592; Prev</a>
      <div class="exercise-range">{{ range_label }}</div>
      <a class="nav-arrow" href="{{ url_for('exercise', start=next_start) }}">Next &#8594;</a>
    </div>
  </section>

  <section class="exercise-calendar" style="margin-top: 1rem;">
    <div class="exercise-weekdays">
      {% for label in weekday_labels %}
        <div class="exercise-weekday">{{ label }}</div>
      {% endfor %}
    </div>
    <div class="exercise-grid">
    {% for day in days %}
      <div class="exercise-cell" data-date="{{ day.date }}">
        <div class="exercise-date">{{ day.label }}</div>
        <div class="exercise-entries">
          {% for entry in day.entries %}
            <div
              class="exercise-entry exercise-entry--{{ entry.person }}"
              data-id="{{ entry.id }}"
              data-person="{{ entry.person }}"
              data-exercise="{{ entry.exercise }}"
              data-duration="{{ entry.duration_raw }}"
              data-met="{{ entry.met }}"
            >
              <div class="exercise-name">{{ entry.exercise }}</div>
              <div class="exercise-duration">{{ entry.duration }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
    </div>
  </section>

  <div class="modal-backdrop" id="exercise-modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="exercise-modal-title">
      <div class="modal-header">
        <h3 id="exercise-modal-title">Log exercise</h3>
        <button class="modal-close" type="button" aria-label="Close">&times;</button>
      </div>
      <p class="modal-date" id="exercise-modal-date"></p>
      <form method="post" class="modal-form" action="{{ url_for('exercise') }}">
        <input type="hidden" name="action" id="exercise-action" value="upsert" />
        <input type="hidden" name="start" value="{{ start_date }}" />
        <input type="hidden" name="entry_date" id="exercise-date-input" />
        <input type="hidden" name="entry_id" id="exercise-entry-id" />
        <div class="tabs exercise-person-tabs">
          <button class="tab active" type="button" data-person="christian">Christian</button>
          <button class="tab" type="button" data-person="krysty">Krysty</button>
        </div>
        <input type="hidden" name="person" id="exercise-person-input" value="christian" />
        <label>
          Exercise
          <input type="text" name="exercise" id="exercise-input" required />
        </label>
        <label>
          Duration (min)
          <input type="number" name="duration" id="exercise-duration-input" min="0" step="0.1" required />
        </label>
        <label>
          MET
          <input type="number" name="met" id="exercise-met-input" min="0" step="0.1" required />
        </label>
        <div class="modal-actions">
          <button class="button" type="submit">Submit</button>
          <button class="icon-button" id="exercise-delete-button" type="button" aria-label="Delete">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M9 3h6l1 2h4v2H4V5h4l1-2Zm1 7h2v8h-2v-8Zm4 0h2v8h-2v-8ZM7 10h2v8H7v-8Zm-1 11h12a2 2 0 0 0 2-2V9H4v10a2 2 0 0 0 2 2Z"
                fill="currentColor"
              />
            </svg>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("exercise-modal");
      const modalDate = document.getElementById("exercise-modal-date");
      const dateInput = document.getElementById("exercise-date-input");
      const entryIdInput = document.getElementById("exercise-entry-id");
      const actionInput = document.getElementById("exercise-action");
      const personInput = document.getElementById("exercise-person-input");
      const exerciseInput = document.getElementById("exercise-input");
      const durationInput = document.getElementById("exercise-duration-input");
      const metInput = document.getElementById("exercise-met-input");
      const personTabs = document.querySelectorAll(".exercise-person-tabs .tab");
      const deleteButton = document.getElementById("exercise-delete-button");
      const closeButton = modal?.querySelector(".modal-close");

      const setPerson = (person) => {
        if (!personInput) return;
        personInput.value = person;
        personTabs.forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.person === person);
        });
      };

      personTabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const person = tab.dataset.person || "christian";
          setPerson(person);
        });
      });

      const closeModal = () => {
        if (!modal) return;
        modal.classList.remove("open");
        modal.setAttribute("aria-hidden", "true");
      };

      const openModalForDate = (dateValue) => {
        if (!modal || !dateInput) return;
        dateInput.value = dateValue;
        if (modalDate) {
          modalDate.textContent = `Date: ${dateValue}`;
        }
        if (entryIdInput) entryIdInput.value = "";
        if (actionInput) actionInput.value = "upsert";
        if (exerciseInput) exerciseInput.value = "";
        if (durationInput) durationInput.value = "";
        if (metInput) metInput.value = "";
        setPerson("christian");
        modal.classList.add("open");
        modal.setAttribute("aria-hidden", "false");
      };

      document.querySelectorAll(".exercise-cell").forEach((cell) => {
        cell.addEventListener("click", () => {
          const dateValue = cell.dataset.date || "";
          openModalForDate(dateValue);
        });
      });

      document.querySelectorAll(".exercise-entry").forEach((entry) => {
        entry.addEventListener("click", (event) => {
          event.stopPropagation();
          const dateValue = entry.closest(".exercise-cell")?.dataset.date || "";
          if (!modal || !dateInput) return;
          dateInput.value = dateValue;
          if (modalDate) {
            modalDate.textContent = `Date: ${dateValue}`;
          }
          if (entryIdInput) entryIdInput.value = entry.dataset.id || "";
          if (exerciseInput) exerciseInput.value = entry.dataset.exercise || "";
          if (durationInput) durationInput.value = entry.dataset.duration || "";
          if (metInput) metInput.value = entry.dataset.met || "";
          setPerson(entry.dataset.person || "christian");
          if (actionInput) actionInput.value = "upsert";
          modal.classList.add("open");
          modal.setAttribute("aria-hidden", "false");
        });
      });

      deleteButton?.addEventListener("click", () => {
        if (!entryIdInput || !entryIdInput.value) return;
        if (actionInput) actionInput.value = "delete";
        deleteButton.closest("form")?.submit();
      });

      closeButton?.addEventListener("click", closeModal);
      modal?.addEventListener("click", (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });
    });
  </script>
{% endblock %}
